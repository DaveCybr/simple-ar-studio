<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR Viewer</title>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        color: white;
        font-family: system-ui, -apple-system, sans-serif;
      }
      .loading.hidden {
        display: none;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255,255,255,0.3);
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .hint {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 12px 24px;
        border-radius: 30px;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 14px;
        z-index: 100;
        text-align: center;
        backdrop-filter: blur(10px);
      }
    </style>
  </head>
  <body>
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Memuat AR Experience...</p>
      <p style="font-size: 12px; opacity: 0.7;">Izinkan akses kamera</p>
    </div>

    <div class="hint" id="hint">
      ðŸ“± Arahkan kamera ke marker
    </div>

    <script>
      // Get parameters from URL
      const params = new URLSearchParams(window.location.search);
      const mindUrl = params.get('mind');
      const contentUrl = params.get('content');
      const contentType = params.get('type') || 'video';
      const scale = parseFloat(params.get('scale') || '1');

      if (!mindUrl || !contentUrl) {
        document.getElementById('loading').innerHTML = '<p style="color: #ef4444;">Error: Missing parameters</p>';
      } else {
        // Create A-Frame scene dynamically
        const scene = document.createElement('a-scene');
        scene.setAttribute('mindar-image', `imageTargetSrc: ${mindUrl}; autoStart: true; uiLoading: no; uiScanning: no; uiError: no;`);
        scene.setAttribute('color-space', 'sRGB');
        scene.setAttribute('renderer', 'colorManagement: true, physicallyCorrectLights');
        scene.setAttribute('vr-mode-ui', 'enabled: false');
        scene.setAttribute('device-orientation-permission-ui', 'enabled: false');

        // Assets
        const assets = document.createElement('a-assets');
        
        if (contentType === 'video') {
          const video = document.createElement('video');
          video.id = 'ar-video';
          video.src = contentUrl;
          video.setAttribute('preload', 'auto');
          video.setAttribute('loop', 'true');
          video.setAttribute('playsinline', '');
          video.setAttribute('webkit-playsinline', '');
          video.setAttribute('crossorigin', 'anonymous');
          video.muted = true;
          assets.appendChild(video);
        } else {
          const img = document.createElement('img');
          img.id = 'ar-image';
          img.src = contentUrl;
          img.setAttribute('crossorigin', 'anonymous');
          assets.appendChild(img);
        }
        
        scene.appendChild(assets);

        // Camera
        const camera = document.createElement('a-camera');
        camera.setAttribute('position', '0 0 0');
        camera.setAttribute('look-controls', 'enabled: false');
        scene.appendChild(camera);

        // Target entity
        const targetEntity = document.createElement('a-entity');
        targetEntity.setAttribute('mindar-image-target', 'targetIndex: 0');
        targetEntity.id = 'target';

        // Calculate scaled dimensions
        const baseWidth = 1 * scale;
        const baseHeight = 0.5625 * scale; // 16:9 aspect ratio

        if (contentType === 'video') {
          // Video plane
          const videoPlane = document.createElement('a-video');
          videoPlane.setAttribute('src', '#ar-video');
          videoPlane.setAttribute('position', '0 0 0');
          videoPlane.setAttribute('width', baseWidth.toString());
          videoPlane.setAttribute('height', baseHeight.toString());
          videoPlane.setAttribute('rotation', '0 0 0');
          targetEntity.appendChild(videoPlane);
        } else {
          // Image plane - 16:9 aspect ratio
          const imagePlane = document.createElement('a-image');
          imagePlane.setAttribute('src', '#ar-image');
          imagePlane.setAttribute('position', '0 0 0');
          imagePlane.setAttribute('width', baseWidth.toString());
          imagePlane.setAttribute('height', baseHeight.toString());
          imagePlane.setAttribute('rotation', '0 0 0');
          targetEntity.appendChild(imagePlane);
        }

        scene.appendChild(targetEntity);
        document.body.appendChild(scene);

        // Event listeners
        scene.addEventListener('arReady', () => {
          document.getElementById('loading').classList.add('hidden');
        });

        scene.addEventListener('arError', () => {
          document.getElementById('loading').innerHTML = '<p style="color: #ef4444;">Error: Tidak dapat mengakses kamera</p>';
        });

        // Target found/lost events
        targetEntity.addEventListener('targetFound', () => {
          document.getElementById('hint').textContent = 'âœ… Marker terdeteksi!';
          document.getElementById('hint').style.background = 'rgba(34, 197, 94, 0.9)';
          
          if (contentType === 'video') {
            const video = document.getElementById('ar-video');
            if (video) {
              video.muted = false;
              video.play().catch(e => console.log('Autoplay prevented:', e));
            }
          }
        });

        targetEntity.addEventListener('targetLost', () => {
          document.getElementById('hint').textContent = 'ðŸ“± Arahkan kamera ke marker';
          document.getElementById('hint').style.background = 'rgba(0,0,0,0.7)';
          
          if (contentType === 'video') {
            const video = document.getElementById('ar-video');
            if (video) {
              video.pause();
            }
          }
        });
      }
    </script>
  </body>
</html>
