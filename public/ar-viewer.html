<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR Viewer - Multi Target (Android Fixed)</title>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        color: white;
        font-family: system-ui, -apple-system, sans-serif;
      }
      .loading.hidden {
        display: none;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .hint {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 12px 24px;
        border-radius: 30px;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 14px;
        z-index: 100;
        text-align: center;
        backdrop-filter: blur(10px);
        max-width: 90%;
      }
      .marker-count {
        position: fixed;
        top: 80px;
        right: 16px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 12px;
        z-index: 100;
        backdrop-filter: blur(10px);
      }
    </style>
  </head>
  <body>
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Memuat AR Experience...</p>
      <p style="font-size: 12px; opacity: 0.7">Mohon tunggu...</p>
    </div>

    <div class="hint" id="hint">ðŸ“± Arahkan kamera ke salah satu marker</div>
    <div class="marker-count" id="marker-count"></div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const markersParam = params.get("markers");
      let markers = [];

      if (markersParam) {
        try {
          markers = JSON.parse(decodeURIComponent(markersParam));
        } catch (e) {
          console.error("Parse error:", e);
        }
      }

      if (markers.length === 0) {
        document.getElementById("loading").innerHTML =
          '<p style="color: #ef4444;">Error: No markers</p>';
      } else {
        document.getElementById(
          "marker-count"
        ).textContent = `${markers.length} marker tersedia`;

        // âœ… FIX: Preload dengan proper video loading untuk Android
        async function preloadMedia(marker) {
          return new Promise((resolve) => {
            if (marker.type === "video") {
              const video = document.createElement("video");

              // âœ… CRITICAL: Set crossOrigin SEBELUM src (Android requirement)
              video.crossOrigin = "anonymous";
              video.setAttribute("playsinline", "");
              video.setAttribute("webkit-playsinline", "");
              video.muted = true; // âœ… Android autoplay policy

              const timeout = setTimeout(() => {
                console.warn("Video load timeout, using fallback dimensions");
                resolve({ ...marker, width: 16, height: 9 });
              }, 8000);

              // âœ… FIX: Wait for loadedmetadata (cukup untuk dapat dimensi)
              video.onloadedmetadata = () => {
                clearTimeout(timeout);
                console.log(
                  `Video loaded: ${video.videoWidth}x${video.videoHeight}`
                );
                resolve({
                  ...marker,
                  width: video.videoWidth || 16,
                  height: video.videoHeight || 9,
                });
              };

              video.onerror = (e) => {
                clearTimeout(timeout);
                console.error("Video load error:", e);
                resolve({ ...marker, width: 16, height: 9 });
              };

              // âœ… Set src dan load
              video.src = marker.content;
              video.load();
            } else {
              const img = new Image();
              img.crossOrigin = "anonymous";

              const timeout = setTimeout(() => {
                resolve({ ...marker, width: 16, height: 9 });
              }, 5000);

              img.onload = () => {
                clearTimeout(timeout);
                resolve({
                  ...marker,
                  width: img.naturalWidth,
                  height: img.naturalHeight,
                });
              };
              img.onerror = () => {
                clearTimeout(timeout);
                resolve({ ...marker, width: 16, height: 9 });
              };
              img.src = marker.content;
            }
          });
        }

        async function createMultiTargetScene() {
          console.log("Loading", markers.length, "markers with multi-target");

          const loadedMarkers = await Promise.all(markers.map(preloadMedia));

          // ALL markers MUST use the SAME .mind file
          const mindUrl = loadedMarkers[0].mind;

          const scene = document.createElement("a-scene");
          scene.setAttribute(
            "mindar-image",
            `imageTargetSrc: ${mindUrl}; ` +
              `autoStart: true; ` +
              `uiLoading: no; ` +
              `uiScanning: no; ` +
              `uiError: no; ` +
              `maxTrack: ${loadedMarkers.length};`
          );
          scene.setAttribute("color-space", "sRGB");
          scene.setAttribute(
            "renderer",
            "colorManagement: true, physicallyCorrectLights"
          );
          scene.setAttribute("vr-mode-ui", "enabled: false");
          scene.setAttribute(
            "device-orientation-permission-ui",
            "enabled: false"
          );

          // âœ… FIX #1: Assets container dengan timeout yang cukup
          const assets = document.createElement("a-assets");
          assets.setAttribute("timeout", "30000"); // 30 detik untuk loading

          // âœ… FIX #2: Video HARUS di <a-assets>, BUKAN di body!
          loadedMarkers.forEach((marker, index) => {
            if (marker.type === "video") {
              const video = document.createElement("video");
              video.id = `ar-video-${index}`;
              video.src = marker.content;

              // âœ… Android critical attributes
              video.setAttribute("crossorigin", "anonymous");
              video.setAttribute("preload", "auto"); // âœ… auto, bukan metadata
              video.setAttribute("loop", "true");
              video.setAttribute("playsinline", "");
              video.setAttribute("webkit-playsinline", "");
              video.muted = true;

              // âœ… CRITICAL: Append ke ASSETS, bukan body!
              assets.appendChild(video);
            } else {
              const img = document.createElement("img");
              img.id = `ar-image-${index}`;
              img.src = marker.content;
              img.setAttribute("crossorigin", "anonymous");
              assets.appendChild(img);
            }
          });

          scene.appendChild(assets);

          const camera = document.createElement("a-camera");
          camera.setAttribute("position", "0 0 0");
          camera.setAttribute("look-controls", "enabled: false");
          scene.appendChild(camera);

          loadedMarkers.forEach((marker, index) => {
            const aspectRatio = marker.width / marker.height;
            const baseWidth = 1 * marker.scale;
            const baseHeight = (1 / aspectRatio) * marker.scale;

            const targetEntity = document.createElement("a-entity");
            targetEntity.setAttribute(
              "mindar-image-target",
              `targetIndex: ${index}`
            );
            targetEntity.id = `target-${index}`;

            if (marker.type === "video") {
              // âœ… FIX #3: Tidak perlu visible=false, langsung tampilkan
              const videoPlane = document.createElement("a-video");
              videoPlane.setAttribute("src", `#ar-video-${index}`);
              videoPlane.setAttribute("position", "0 0 0");
              videoPlane.setAttribute("width", baseWidth);
              videoPlane.setAttribute("height", baseHeight);
              videoPlane.setAttribute("rotation", "0 0 0");
              // âœ… TIDAK pakai visible=false! Biarkan A-Frame handle
              targetEntity.appendChild(videoPlane);
            } else {
              const imagePlane = document.createElement("a-image");
              imagePlane.setAttribute("src", `#ar-image-${index}`);
              imagePlane.setAttribute("position", "0 0 0");
              imagePlane.setAttribute("width", baseWidth);
              imagePlane.setAttribute("height", baseHeight);
              imagePlane.setAttribute("rotation", "0 0 0");
              targetEntity.appendChild(imagePlane);
            }

            // âœ… FIX #4: Simple play/pause, no reload needed
            targetEntity.addEventListener("targetFound", () => {
              console.log("Found:", marker.name);
              document.getElementById(
                "hint"
              ).textContent = `âœ… ${marker.name} terdeteksi!`;
              document.getElementById("hint").style.background =
                "rgba(34, 197, 94, 0.9)";

              if (marker.type === "video") {
                const video = document.getElementById(`ar-video-${index}`);
                if (video) {
                  // âœ… Android: unmute lalu play
                  video.muted = false;
                  video.play().catch((e) => {
                    console.log("Play error (trying muted):", e);
                    // Fallback: play muted jika unmuted gagal
                    video.muted = true;
                    video.play();
                  });
                }
              }
            });

            targetEntity.addEventListener("targetLost", () => {
              console.log("Lost:", marker.name);
              document.getElementById("hint").textContent =
                "ðŸ“± Arahkan ke salah satu marker";
              document.getElementById("hint").style.background =
                "rgba(0,0,0,0.7)";

              if (marker.type === "video") {
                const video = document.getElementById(`ar-video-${index}`);
                if (video) {
                  video.pause();
                  // âœ… Reset ke awal untuk smooth replay
                  video.currentTime = 0;
                }
              }
            });

            scene.appendChild(targetEntity);
          });

          document.body.appendChild(scene);

          scene.addEventListener("arReady", () => {
            console.log("Multi-target AR ready");
            document.getElementById("loading").classList.add("hidden");
          });

          scene.addEventListener("arError", (e) => {
            console.error("AR Error:", e);
            document.getElementById("loading").innerHTML =
              '<p style="color: #ef4444;">Error: Camera access denied</p><p style="font-size: 12px; margin-top: 10px;">Pastikan browser memiliki izin kamera</p>';
          });
        }

        createMultiTargetScene();
      }
    </script>
  </body>
</html>
