<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR Viewer</title>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      .loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        color: white;
        font-family: system-ui, -apple-system, sans-serif;
      }
      .loading.hidden {
        display: none;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 3px solid rgba(255,255,255,0.3);
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .hint {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 12px 24px;
        border-radius: 30px;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 14px;
        z-index: 100;
        text-align: center;
        backdrop-filter: blur(10px);
        max-width: 90%;
      }
      .marker-count {
        position: fixed;
        top: 80px;
        right: 16px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 12px;
        z-index: 100;
        backdrop-filter: blur(10px);
      }
    </style>
  </head>
  <body>
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Memuat AR Experience...</p>
      <p style="font-size: 12px; opacity: 0.7;">Izinkan akses kamera</p>
    </div>

    <div class="hint" id="hint">
      ðŸ“± Arahkan kamera ke salah satu marker
    </div>

    <div class="marker-count" id="marker-count"></div>

    <script>
      // Get parameters from URL
      const params = new URLSearchParams(window.location.search);
      const markersParam = params.get('markers');
      
      // Backward compatibility: single marker mode
      const singleMind = params.get('mind');
      const singleContent = params.get('content');
      const singleType = params.get('type') || 'video';
      const singleScale = parseFloat(params.get('scale') || '1');

      let markers = [];
      
      if (markersParam) {
        try {
          markers = JSON.parse(decodeURIComponent(markersParam));
        } catch (e) {
          console.error('Error parsing markers:', e);
        }
      } else if (singleMind && singleContent) {
        // Backward compatibility
        markers = [{
          mind: singleMind,
          content: singleContent,
          type: singleType,
          scale: singleScale,
          name: 'Marker'
        }];
      }

      if (markers.length === 0) {
        document.getElementById('loading').innerHTML = '<p style="color: #ef4444;">Error: No markers found</p>';
      } else {
        document.getElementById('marker-count').textContent = `${markers.length} marker tersedia`;

        // Preload all media to get dimensions
        async function preloadMedia(marker) {
          return new Promise((resolve) => {
            if (marker.type === 'video') {
              const video = document.createElement('video');
              video.src = marker.content;
              video.setAttribute('crossorigin', 'anonymous');
              video.addEventListener('loadedmetadata', () => {
                resolve({
                  ...marker,
                  width: video.videoWidth,
                  height: video.videoHeight
                });
              });
              video.addEventListener('error', () => {
                resolve({ ...marker, width: 16, height: 9 }); // Fallback
              });
              video.load();
            } else {
              const img = new Image();
              img.crossOrigin = 'anonymous';
              img.onload = () => {
                resolve({
                  ...marker,
                  width: img.naturalWidth,
                  height: img.naturalHeight
                });
              };
              img.onerror = () => {
                resolve({ ...marker, width: 16, height: 9 }); // Fallback
              };
              img.src = marker.content;
            }
          });
        }

        async function createMultiMarkerScene() {
          // Preload all media
          const loadedMarkers = await Promise.all(markers.map(preloadMedia));

          // Create A-Frame scene dynamically
          const scene = document.createElement('a-scene');
          
          // Combine all .mind files (they should be combined beforehand for multi-target)
          // For now, we'll use the first marker's mind file as the main target
          // MindAR supports multiple targets in a single .mind file
          const mindUrl = loadedMarkers[0].mind;
          
          scene.setAttribute('mindar-image', `imageTargetSrc: ${mindUrl}; autoStart: true; uiLoading: no; uiScanning: no; uiError: no; maxTrack: ${loadedMarkers.length};`);
          scene.setAttribute('color-space', 'sRGB');
          scene.setAttribute('renderer', 'colorManagement: true, physicallyCorrectLights');
          scene.setAttribute('vr-mode-ui', 'enabled: false');
          scene.setAttribute('device-orientation-permission-ui', 'enabled: false');

          // Assets
          const assets = document.createElement('a-assets');
          
          loadedMarkers.forEach((marker, index) => {
            if (marker.type === 'video') {
              const video = document.createElement('video');
              video.id = `ar-video-${index}`;
              video.src = marker.content;
              video.setAttribute('preload', 'auto');
              video.setAttribute('loop', 'true');
              video.setAttribute('playsinline', '');
              video.setAttribute('webkit-playsinline', '');
              video.setAttribute('crossorigin', 'anonymous');
              video.muted = true;
              assets.appendChild(video);
            } else {
              const img = document.createElement('img');
              img.id = `ar-image-${index}`;
              img.src = marker.content;
              img.setAttribute('crossorigin', 'anonymous');
              assets.appendChild(img);
            }
          });
          
          scene.appendChild(assets);

          // Camera
          const camera = document.createElement('a-camera');
          camera.setAttribute('position', '0 0 0');
          camera.setAttribute('look-controls', 'enabled: false');
          scene.appendChild(camera);

          // Create target entities for each marker
          loadedMarkers.forEach((marker, index) => {
            const aspectRatio = marker.width / marker.height;
            const baseWidth = 1 * marker.scale;
            const baseHeight = (1 / aspectRatio) * marker.scale;

            const targetEntity = document.createElement('a-entity');
            targetEntity.setAttribute('mindar-image-target', `targetIndex: ${index}`);
            targetEntity.id = `target-${index}`;

            if (marker.type === 'video') {
              const videoPlane = document.createElement('a-video');
              videoPlane.setAttribute('src', `#ar-video-${index}`);
              videoPlane.setAttribute('position', '0 0 0');
              videoPlane.setAttribute('width', baseWidth.toString());
              videoPlane.setAttribute('height', baseHeight.toString());
              videoPlane.setAttribute('rotation', '0 0 0');
              targetEntity.appendChild(videoPlane);
            } else {
              const imagePlane = document.createElement('a-image');
              imagePlane.setAttribute('src', `#ar-image-${index}`);
              imagePlane.setAttribute('position', '0 0 0');
              imagePlane.setAttribute('width', baseWidth.toString());
              imagePlane.setAttribute('height', baseHeight.toString());
              imagePlane.setAttribute('rotation', '0 0 0');
              targetEntity.appendChild(imagePlane);
            }

            // Target found/lost events
            targetEntity.addEventListener('targetFound', () => {
              document.getElementById('hint').textContent = `âœ… ${marker.name || 'Marker'} terdeteksi!`;
              document.getElementById('hint').style.background = 'rgba(34, 197, 94, 0.9)';
              
              if (marker.type === 'video') {
                const video = document.getElementById(`ar-video-${index}`);
                if (video) {
                  video.muted = false;
                  video.play().catch(e => console.log('Autoplay prevented:', e));
                }
              }
            });

            targetEntity.addEventListener('targetLost', () => {
              document.getElementById('hint').textContent = 'ðŸ“± Arahkan kamera ke salah satu marker';
              document.getElementById('hint').style.background = 'rgba(0,0,0,0.7)';
              
              if (marker.type === 'video') {
                const video = document.getElementById(`ar-video-${index}`);
                if (video) {
                  video.pause();
                }
              }
            });

            scene.appendChild(targetEntity);
          });

          document.body.appendChild(scene);

          // Scene ready event
          scene.addEventListener('arReady', () => {
            document.getElementById('loading').classList.add('hidden');
          });

          scene.addEventListener('arError', () => {
            document.getElementById('loading').innerHTML = '<p style="color: #ef4444;">Error: Tidak dapat mengakses kamera</p>';
          });
        }

        createMultiMarkerScene();
      }
    </script>
  </body>
</html>
